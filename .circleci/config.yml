version: 2
jobs:
  build:
    docker:
      - image: kappelmann/isabelle-dev:latest

    steps:
      - checkout
      - run: git submodule sync
      - run: git submodule update --init

      - restore_cache:
          key: v1-Isabelle-{{ checksum "ISABELLE_VERSION" }}-{{ checksum ".circleci/prepare_isabelle.sh" }}

      - run:
          name: Prepare Isabelle
          command: .circleci/prepare_isabelle.sh

      - run:
          name: Build base image
          command: ~/Isabelle/bin/isabelle build -vbRD .

      - save_cache:
          key: v1-Isabelle-{{ checksum "ISABELLE_VERSION" }}-{{ checksum ".circleci/prepare_isabelle.sh" }}
          paths:
            - ~/.isabelle
            - ~/Isabelle

      - run:
          name: Build theories
          command: ~/Isabelle/bin/isabelle build -vD .
